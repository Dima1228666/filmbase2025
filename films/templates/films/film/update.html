{% extends 'films/base.html' %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container mt-4">
    <form method="POST" enctype="multipart/form-data" id="film-form">
        {% csrf_token %}
    
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Редактирование: {{ form.instance.name }}</h1>
            
            <button type="submit" class="btn btn-primary">
                <i class="bi-check-lg"></i> Сохранить изменения
            </button>
        </div>
    
        <div class="card mb-4">
            <div class="card-header">Основная информация</div>
            <div class="card-body">
                {% bootstrap_form form %}
            </div>
        </div>
    
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Съемочная группа</span>
                <button type="button" class="btn btn-sm btn-success" id="add-form">
                    <i class="bi-plus-lg"></i> Добавить участника
                </button>
            </div>
            
            <div class="card-body">
                {{ formset.management_form }}

                <!-- Контейнер для строк -->
                <div id="formset-container">
                    {% for crew_form in formset %}
                        <div class="row mb-2 align-items-end crew-form-row">
                            {% for hidden in crew_form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}

                            <div class="col-md-5">
                                <label class="form-label small text-muted">Персона</label>
                                {{ crew_form.person }}
                                {% if crew_form.person.errors %}
                                    <div class="text-danger small">{{ crew_form.person.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-5">
                                <label class="form-label small text-muted">Роль</label>
                                {{ crew_form.role }}
                            </div>

                            <div class="col-md-2">
                                {% if formset.can_delete %}
                                    <div class="form-check d-none">
                                        {{ crew_form.DELETE }}
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm w-100 delete-form-btn">
                                        <i class="bi-trash"></i> Удалить
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    
        <div id="empty-form-template" class="d-none">
            <div class="row mb-2 align-items-end crew-form-row">
                <div class="col-md-5">
                    <label class="form-label small text-muted">Персона</label>
                    {{ formset.empty_form.person }}
                </div>
                <div class="col-md-5">
                    <label class="form-label small text-muted">Роль</label>
                    {{ formset.empty_form.role }}
                </div>
                <div class="col-md-2">
                    <div class="form-check d-none">
                        {{ formset.empty_form.DELETE }}
                    </div>
                    <button type="button" class="btn btn-danger btn-sm w-100 delete-form-btn">
                        <i class="bi-trash"></i> Удалить
                    </button>
                </div>
            </div>
        </div>
    
        <div class="d-grid gap-2 mb-5">
             <button type="submit" class="btn btn-primary btn-lg">Сохранить изменения</button>
        </div>

    </form>
</div>
    
{{ form.media }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('formset-container');
    const addButton = document.getElementById('add-form');
    const totalFormsInput = document.getElementById('id_filmcrew_set-TOTAL_FORMS');
    const template = document.getElementById('empty-form-template').innerHTML;
    
    addButton.addEventListener('click', function() {
        const formCount = parseInt(totalFormsInput.value);
        const newFormHtml = template.replace(/__prefix__/g, formCount);
        container.insertAdjacentHTML('afterbegin', newFormHtml);
        totalFormsInput.value = formCount + 1;
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.closest('.delete-form-btn')) {
            const row = e.target.closest('.crew-form-row');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.classList.add('d-none');
            } else {
                row.remove();
            }
        }
    });
});
</script>
{% endblock %}